name: Validate and deploy Kestra flows (API)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  FLOW_FILE: ./kestra/flows/register-host-in-ansible-inventory.yaml
  FLOW_ID: register-host-in-ansible-inventory
  FLOW_NAMESPACE: company.team
  # Must include scheme, e.g. https://kestra.example.com
  KESTRA_SERVER: ${{ secrets.KESTRA_HOSTNAME }}
  # Map secrets to env so we can use them in `if:` expressions
  KESTRA_USERNAME: ${{ secrets.KESTRA_USERNAME }}
  KESTRA_PASSWORD: ${{ secrets.KESTRA_PASSWORD }}
  KESTRA_TOKEN:    ${{ secrets.KESTRA_TOKEN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show flow head (debug)
        run: sed -n '1,120p' "$FLOW_FILE" || true

      - name: Validate flows locally
        uses: kestra-io/validate-action@v0.24.0
        with:
          directory: ./kestra/flows
          resource: flow

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity checks
        run: |
          set -eu
          test -f "$FLOW_FILE" || { echo "Flow not found: $FLOW_FILE"; exit 1; }
          if [ -z "${KESTRA_SERVER:-}" ]; then
            echo "KESTRA_HOSTNAME secret is required (e.g., https://kestra.example.com)"; exit 1
          fi
          case "$KESTRA_SERVER" in
            http://*|https://*) : ;;
            *) echo "KESTRA_HOSTNAME must include http(s):// â€” got: $KESTRA_SERVER"; exit 1 ;;
          esac

      - name: Strip UTF-8 BOM if present (no-op otherwise)
        run: |
          python - <<'PY'
          import pathlib
          p = pathlib.Path("${{ env.FLOW_FILE }}")
          b = p.read_bytes()
          p.write_bytes(b[3:] if b.startswith(b"\xef\xbb\xbf") else b)
          print("Checked BOM.")
          PY

      # -------- Delete existing flow (OSS API: /flows/delete/by-ids) --------
      - name: Delete existing flow (Basic Auth)
        if: ${{ env.KESTRA_USERNAME != '' && env.KESTRA_PASSWORD != '' }}
        run: |
          set -eu
          url="$KESTRA_SERVER/api/v1/flows/delete/by-ids"
          body=$(jq -nc --arg ns "$FLOW_NAMESPACE" --arg id "$FLOW_ID" '[{"namespace":$ns,"id":$id}]')
          http_code=$(curl -sS -o /tmp/kestra_delete.json -w '%{http_code}' \
            -u "${KESTRA_USERNAME}:${KESTRA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -X POST "$url" \
            --data "$body")
          echo "DELETE-by-ids $url -> HTTP $http_code"
          cat /tmp/kestra_delete.json || true
          case "$http_code" in
            200) echo "Delete-by-ids OK";;
            404) echo "Endpoint not found on this server (unexpected for OSS).";;
            *) echo "Delete failed (HTTP $http_code)"; exit 1;;
          esac

      - name: Delete existing flow (Token)
        if: ${{ env.KESTRA_USERNAME == '' && env.KESTRA_PASSWORD == '' && env.KESTRA_TOKEN != '' }}
        run: |
          set -eu
          url="$KESTRA_SERVER/api/v1/flows/delete/by-ids"
          body=$(jq -nc --arg ns "$FLOW_NAMESPACE" --arg id "$FLOW_ID" '[{"namespace":$ns,"id":$id}]')
          http_code=$(curl -sS -o /tmp/kestra_delete.json -w '%{http_code}' \
            -H "Authorization: Bearer ${KESTRA_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "$url" \
            --data "$body")
          echo "DELETE-by-ids $url -> HTTP $http_code"
          cat /tmp/kestra_delete.json || true
          case "$http_code" in
            200) echo "Delete-by-ids OK";;
            404) echo "Endpoint not found on this server (unexpected for OSS).";;
            *) echo "Delete failed (HTTP $http_code)"; exit 1;;
          esac

      # -------------------- Deploy the updated flow YAML --------------------
      - name: Deploy via Kestra API (Basic Auth)
        if: ${{ env.KESTRA_USERNAME != '' && env.KESTRA_PASSWORD != '' }}
        run: |
          set -eu
          http_code=$(curl -sS -o /tmp/kestra_deploy.json -w '%{http_code}' \
            -u "${KESTRA_USERNAME}:${KESTRA_PASSWORD}" \
            -H "Content-Type: application/x-yaml" \
            --data-binary @"$FLOW_FILE" \
            "$KESTRA_SERVER/api/v1/main/flows")
          echo "POST /main/flows -> HTTP $http_code"
          cat /tmp/kestra_deploy.json || true
          case "$http_code" in
            200|201) echo "Deploy OK (basic auth)";;
            *) echo "Deploy failed (HTTP $http_code)"; exit 1;;
          esac

      - name: Deploy via Kestra API (Token)
        if: ${{ env.KESTRA_USERNAME == '' && env.KESTRA_PASSWORD == '' && env.KESTRA_TOKEN != '' }}
        run: |
          set -eu
          http_code=$(curl -sS -o /tmp/kestra_deploy.json -w '%{http_code}' \
            -H "Authorization: Bearer ${KESTRA_TOKEN}" \
            -H "Content-Type: application/x-yaml" \
            --data-binary @"$FLOW_FILE" \
            "$KESTRA_SERVER/api/v1/main/flows")
          echo "POST /main/flows -> HTTP $http_code"
          cat /tmp/kestra_deploy.json || true
          case "$http_code" in
            200|201) echo "Deploy OK (token)";;
            *) echo "Deploy failed (HTTP $http_code)"; exit 1;;
          esac

      - name: Fail if no credentials provided
        if: ${{ (env.KESTRA_USERNAME == '' || env.KESTRA_PASSWORD == '') && env.KESTRA_TOKEN == '' }}
        run: |
          echo "No credentials provided. Set either KESTRA_USERNAME + KESTRA_PASSWORD or KESTRA_TOKEN as repository secrets."
          exit 1