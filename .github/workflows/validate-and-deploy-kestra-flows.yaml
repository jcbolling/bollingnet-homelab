name: Validate and deploy Kestra flows (API)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  FLOW_FILE: ./kestra/flows/register-host-in-ansible-inventory.yaml

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug: show flow head
        run: |
          sed -n '1,120p' "$FLOW_FILE" || true

      - name: Validate locally
        uses: kestra-io/validate-action@v0.24.0
        with:
          directory: ./kestra/flows
          resource: flow
          # no server => local validation

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity: ensure single flow exists
        run: |
          test -f "$FLOW_FILE" || { echo "Flow not found: $FLOW_FILE"; exit 1; }

      # Optional: strip any UTF-8 BOM to avoid SnakeYAML quirks server-side
      - name: Strip BOM (no-op if none)
        run: |
          python - <<'PY'
          import sys, pathlib
          p = pathlib.Path("${{ env.FLOW_FILE }}")
          b = p.read_bytes()
          bom = b"\xef\xbb\xbf"
          if b.startswith(bom):
              p.write_bytes(b[len(bom):])
              print("Removed UTF-8 BOM from flow file.")
          else:
              print("No BOM present.")
          PY

      # Deploy via API (Basic Auth)
      - name: Deploy flow via Kestra API (Basic Auth)
        if: ${{ secrets.KESTRA_USERNAME && secrets.KESTRA_PASSWORD }}
        run: |
          set -eu
          SERVER="${{ secrets.KESTRA_HOSTNAME }}"
          [[ "$SERVER" == http://* || "$SERVER" == https://* ]] || { echo "KESTRA_HOSTNAME must include http(s)://"; exit 1; }
          # Create/update flow by posting YAML body as-is
          http_code=$(curl -sS -o /tmp/kestra_deploy_resp.json -w '%{http_code}' \
            -u "${{ secrets.KESTRA_USERNAME }}:${{ secrets.KESTRA_PASSWORD }}" \
            -H "Content-Type: application/x-yaml" \
            --data-binary @"$FLOW_FILE" \
            "$SERVER/api/v1/main/flows")
          echo "HTTP $http_code"
          cat /tmp/kestra_deploy_resp.json || true
          case "$http_code" in
            200|201) echo "Deploy OK";;
            *) echo "Deploy failed (HTTP $http_code)"; exit 1;;
          esac

      # Deploy via API (Token) â€” if you use tokens instead of basic auth
      - name: Deploy flow via Kestra API (Token)
        if: ${{ secrets.KESTRA_TOKEN && !secrets.KESTRA_USERNAME }}
        run: |
          set -eu
          SERVER="${{ secrets.KESTRA_HOSTNAME }}"
          [[ "$SERVER" == http://* || "$SERVER" == https://* ]] || { echo "KESTRA_HOSTNAME must include http(s)://"; exit 1; }
          http_code=$(curl -sS -o /tmp/kestra_deploy_resp.json -w '%{http_code}' \
            -H "Authorization: Bearer ${{ secrets.KESTRA_TOKEN }}" \
            -H "Content-Type: application/x-yaml" \
            --data-binary @"$FLOW_FILE" \
            "$SERVER/api/v1/main/flows")
          echo "HTTP $http_code"
          cat /tmp/kestra_deploy_resp.json || true
          case "$http_code" in
            200|201) echo "Deploy OK";;
            *) echo "Deploy failed (HTTP $http_code)"; exit 1;;
          esac