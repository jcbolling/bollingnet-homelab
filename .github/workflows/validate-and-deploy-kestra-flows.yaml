name: Validate and deploy Kestra flows

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Kestra flows (local)
    steps:
      - name: Checkout repository content
        uses: actions/checkout@v4

      # Optional: show what we're validating
      - name: List flows (debug)
        run: |
          echo "=== ./kestra/flows tree ==="
          ls -laR ./kestra/flows || true
          echo "=== File head ==="
          sed -n '1,120p' ./kestra/flows/register-host-in-ansible-inventory.yaml || true

      # Local validation avoids the server's mis-parse of scalars like "inventory.yaml"
      - name: Validate flows locally
        uses: kestra-io/validate-action@v0.24.0
        with:
          directory: ./kestra/flows
          resource: flow
          # No server/user/password => runs locally

  deploy:
    runs-on: ubuntu-latest
    name: Deploy Kestra flows
    needs: validate
    steps:
      - name: Checkout repository content
        uses: actions/checkout@v4

      - name: Deploy flows to Kestra
        uses: kestra-io/deploy-action@v0.22.0
        with:
          namespace: company.team
          directory: ./kestra/flows
          resource: flow
          server: ${{ secrets.KESTRA_HOSTNAME }}
          user: ${{ secrets.KESTRA_USERNAME }}
          password: ${{ secrets.KESTRA_PASSWORD }}
          delete: false