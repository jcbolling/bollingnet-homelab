# roles/standalone-dns/tasks/main.yml

- name: Gather facts for standalone Technitium node
  ansible.builtin.setup:
  tags: [standalone_dns]

########################################################
# PREP HOST: FREE PORT 53 + HOST DNS
########################################################

- name: Ensure DNSStubListener is disabled in resolved.conf
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?DNSStubListener='
    line: 'DNSStubListener=no'
    create: true
    mode: "0644"
  tags: [standalone_dns]

- name: Set explicit upstream DNS in resolved.conf
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?DNS='
    line: "DNS={{ standalone_dns_host_upstream_dns | join(' ') }}"
    insertafter: '^\[Resolve\]'
    create: true
    mode: "0644"
  tags: [standalone_dns]

- name: Stat /etc/resolv.conf to see if it is a symlink
  ansible.builtin.stat:
    path: /etc/resolv.conf
  register: standalone_dns_resolv_conf_stat
  tags: [standalone_dns]

- name: Remove /etc/resolv.conf if it is a symlink
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: absent
  when: standalone_dns_resolv_conf_stat.stat.islnk | default(false)
  tags: [standalone_dns]

- name: Create static /etc/resolv.conf with host upstream DNS
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      {% for ns in standalone_dns_host_upstream_dns %}
      nameserver {{ ns }}
      {% endfor %}
  tags: [standalone_dns]

- name: Stop and disable systemd-resolved (free port 53)
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: false
  tags: [standalone_dns]

########################################################
# STANDALONE TECHNITIUM STACK
########################################################

- name: Ensure standalone DNS root directory exists
  ansible.builtin.file:
    path: "{{ standalone_dns_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [standalone_dns]

- name: Ensure Technitium data directory exists
  ansible.builtin.file:
    path: "{{ standalone_dns_root }}/technitium"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [standalone_dns]

- name: Deploy docker-compose.yml for standalone Technitium
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: "{{ standalone_dns_root }}/docker-compose.yaml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart standalone-dns stack
  tags: [standalone_dns]

- name: Ensure standalone Technitium stack is running
  community.docker.docker_compose_v2:
    project_src: "{{ standalone_dns_root }}"
    state: present
  tags: [standalone_dns]
